# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|

  # Define the VM box
  config.vm.box = "generic/ubuntu1804"

  # Configure the network
  config.vm.network "private_network", ip: "192.168.33.10"
  config.vm.network "forwarded_port", guest: 80, host: 8080

  # Provision the VM
  config.vm.provision "shell", inline: <<-SHELL
    # Update the package manager
    sudo apt-get update

    # Install Apache
    sudo apt-get install -y apache2

    # Enable the necessary modules
    sudo a2enmod proxy
    sudo a2enmod proxy_http
    sudo a2enmod proxy_balancer
    sudo a2enmod lbmethod_byrequests

    # Create the virtual host file for the reverse proxy
    sudo touch /etc/apache2/sites-available/reverse-proxy.conf
    sudo bash -c 'cat > /etc/apache2/sites-available/reverse-proxy.conf << EOL
<VirtualHost *:80>
  ProxyPreserveHost On
  ProxyPass / http://127.0.0.1:2123/
  ProxyPassReverse / http://127.0.0.1:2123/
  ServerName reverse-proxy.example.com
</VirtualHost>
EOL'

    # Enable the virtual host
    sudo a2ensite reverse-proxy.conf

    # Restart Apache
    sudo service apache2 restart
  SHELL
end